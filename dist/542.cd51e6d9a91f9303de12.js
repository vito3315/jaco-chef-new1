"use strict";(self.webpackChunkpackage_json=self.webpackChunkpackage_json||[]).push([[542],{5959:(t,e,a)=>{a.r(e),a.d(e,{default:()=>Z}),a(2603);var n=a(5861),s=a(5671),i=a(3144),o=a(7326),r=a(136),c=a(6215),l=a(1120),m=a(4942),u=a(4687),h=a.n(u),d=a(7294),g=a(30),p=a(1822),f=a(3892),y=a(5705),b=a(1647),_=a(6406);var v=a(7563);function w(t){var e=new Date(t),a=""+(e.getMonth()+1),n=""+e.getDate(),s=e.getFullYear();return a.length<2&&(a="0"+a),n.length<2&&(n="0"+n),[s,a,n].join("-")}var Z=function(t){(0,r.Z)(D,t);var e,a,u,Z,k,C=(Z=D,k=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}(),function(){var t,e=(0,l.Z)(Z);if(k){var a=(0,l.Z)(this).constructor;t=Reflect.construct(e,arguments,a)}else t=e.apply(this,arguments);return(0,c.Z)(this,t)});function D(t){var e;return(0,s.Z)(this,D),e=C.call(this,t),(0,m.Z)((0,o.Z)(e),"map",null),(0,m.Z)((0,o.Z)(e),"heatmap",null),(0,m.Z)((0,o.Z)(e),"myGeoObject",null),(0,m.Z)((0,o.Z)(e),"getData",(function(t){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return e.setState({is_load:!0}),fetch("https://jacochef.ru/api/index_new.php",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:v.stringify({method:t,module:e.state.module,version:2,login:localStorage.getItem("token"),data:JSON.stringify(a)})}).then((function(t){return t.json()})).then((function(t){if(!1!==t.st||"redir"!=t.type){if(!1!==t.st||"auth"!=t.type)return setTimeout((function(){e.setState({is_load:!1})}),300),t;window.location.pathname="/auth"}else window.location.pathname="/"})).catch((function(t){console.log(t)}))})),e.state={module:"hot_map",module_name:"",is_load:!1,cities:[],city_id:"",date_start:w(new Date),date_end:w(new Date),time_start:"00:00",time_end:"23:59",statAllCount:"",statTrueCount:"",is_new:0,isDrawing:!0},e}return(0,i.Z)(D,[{key:"componentDidMount",value:(u=(0,n.Z)(h().mark((function t(){var e;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.next=2,this.getData("get_all");case 2:e=t.sent,this.setState({cities:e.cities,city_id:e.cities[0].id,module_name:e.module_info.name}),document.title=e.module_info.name;case 5:case"end":return t.stop()}}),t,this)}))),function(){return u.apply(this,arguments)})},{key:"changeCity",value:function(t){var e=t.target.value;this.setState({city_id:e}),setTimeout((function(){}),50)}},{key:"updateData",value:(a=(0,n.Z)(h().mark((function t(){var e,a;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return this.state.statAllCount&&this.setState({statAllCount:"",statTrueCount:""}),this.setState({isDrawing:!0}),e={city_id:this.state.city_id,date_start:this.state.date_start,date_end:this.state.date_end,time_start:this.state.time_start,time_end:this.state.time_end,is_new:this.state.is_new},t.next=5,this.getData("get_orders",e);case 5:a=t.sent,console.log(a),this.getOrders(a.points,a.all_points);case 8:case"end":return t.stop()}}),t,this)}))),function(){return a.apply(this,arguments)})},{key:"getOrders",value:function(t,e){var a=this,n=[];if(e.map((function(t){n.push([parseFloat(t[0]),parseFloat(t[1])])})),this.map){this.map.geoObjects.removeAll(),this.heatmap.destroy(),this.map.setCenter([t[0].home.latitude,t[0].home.longitude]);var s=[{.1:"rgba(128, 255, 0, 0.7)",.2:"rgba(255, 255, 0, 0.8)",.7:"rgba(234, 72, 58, 0.9)",1:"rgba(162, 36, 25, 1)"},{.1:"rgba(162, 36, 25, 0.7)",.2:"rgba(234, 72, 58, 0.8)",.7:"rgba(255, 255, 0, 0.9)",1:"rgba(128, 255, 0, 1)"}],i=[5,10,20,30],o=[.4,.6,.8,1];ymaps.modules.require(["Heatmap"],(function(t){new t(n,{gradient:s[0],radius:i[1],opacity:o[2]}).setMap(a.map)})),t.map((function(t,e){var n=new ymaps.GeoObject({geometry:{type:"Point",coordinates:[t.home.latitude,t.home.longitude]}},{preset:"islands#blackDotIcon",iconColor:"black"});a.map.geoObjects.add(n);var s=[];t.zone.map((function(t,e){s.push(JSON.parse(t.zone))}));for(var i=[],o=0;o<s.length;o++)i[o]=new ymaps.Polygon([s[o]],{hintContent:""},{fillColor:"rgba(187, 0, 37, 0)",strokeColor:"rgb(187, 0, 37)",strokeWidth:5}),a.map.geoObjects.add(i[o]);a.map.geoObjects.events.add("click",a.changeColorPolygon.bind(a))}))}else ymaps.ready((function(){a.map=new ymaps.Map("map",{center:[t[0].home.latitude,t[0].home.longitude],zoom:11},{searchControlProvider:"yandex#search"});var e=[{.1:"rgba(128, 255, 0, 0.7)",.2:"rgba(255, 255, 0, 0.8)",.7:"rgba(234, 72, 58, 0.9)",1:"rgba(162, 36, 25, 1)"},{.1:"rgba(162, 36, 25, 0.7)",.2:"rgba(234, 72, 58, 0.8)",.7:"rgba(255, 255, 0, 0.9)",1:"rgba(128, 255, 0, 1)"}],s=[5,10,20,30],i=[.4,.6,.8,1];ymaps.modules.require(["Heatmap"],(function(t){a.heatmap=new t(n,{gradient:e[0],radius:s[1],opacity:i[2]}),a.heatmap.setMap(a.map)})),t.map((function(t,e){var n=new ymaps.GeoObject({geometry:{type:"Point",coordinates:[t.home.latitude,t.home.longitude]}},{preset:"islands#blackDotIcon",iconColor:"black"});a.map.geoObjects.add(n);var s=[];t.zone.map((function(t,e){s.push(JSON.parse(t.zone))}));for(var i=[],o=0;o<s.length;o++)i[o]=new ymaps.Polygon([s[o]],{hintContent:""},{fillColor:"rgba(187, 0, 37, 0)",strokeColor:"rgb(187, 0, 37)",strokeWidth:5}),a.map.geoObjects.add(i[o]);a.map.geoObjects.events.add("click",a.changeColorPolygon.bind(a))}))}))}},{key:"getCount",value:(e=(0,n.Z)(h().mark((function t(){var e,a,n;return h().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return e=[],this.map.geoObjects.each((function(t){e=e.concat(t.geometry.getCoordinates())})),a={city_id:this.state.city_id,date_start:this.state.date_start,date_end:this.state.date_end,time_start:this.state.time_start,time_end:this.state.time_end,is_new:this.state.is_new,zone:e[e.length-1]},t.next=5,this.getData("getCount",a);case 5:n=t.sent,this.setState({statAllCount:n.all_count,statTrueCount:n.true+" ( "+n.true_percent+"% ) "}),console.log(n);case 8:case"end":return t.stop()}}),t,this)}))),function(){return e.apply(this,arguments)})},{key:"changeDateRange",value:function(t,e){this.setState((0,m.Z)({},t,w(e)))}},{key:"changeData",value:function(t,e){var a;a="is_new"==t?1==e.target.checked?1:0:e.target.value,this.setState((0,m.Z)({},t,a))}},{key:"startDrawing",value:function(){this.setState({isDrawing:!this.state.isDrawing}),ymaps.geoQuery(this.map.geoObjects).setOptions("strokeColor","rgb(187, 0, 37)"),this.myGeoObject=new ymaps.GeoObject({geometry:{type:"Polygon",coordinates:[],fillRule:"nonZero"}},{fillColor:"#00FF00",strokeColor:"#0000FF",opacity:.5,strokeWidth:5,strokeStyle:"shortdash"}),this.map.geoObjects.add(this.myGeoObject),this.myGeoObject.editor.startDrawing()}},{key:"stopDrawing",value:function(){this.setState({isDrawing:!this.state.isDrawing}),this.myGeoObject.editor.stopDrawing()}},{key:"changeColorPolygon",value:function(t){t.get("target").options.set({strokeColor:"rgb(255, 255, 0)"});var e=ymaps.geoQuery(this.map.geoObjects).search('options.strokeColor = "rgb(255, 255, 0)"');e._objects.length>1&&e.setOptions("strokeColor","rgb(187, 0, 37)"),e&&this.map.geoObjects.add(e._objects[0])}},{key:"render",value:function(){return d.createElement(d.Fragment,null,d.createElement(f.Z,{open:this.state.is_load,style:{zIndex:99}},d.createElement(y.Z,{color:"inherit"})),d.createElement(g.ZP,{container:!0,spacing:3},d.createElement(g.ZP,{item:!0,xs:12,sm:12},d.createElement("h1",null,this.state.module_name)),d.createElement(g.ZP,{item:!0,xs:12,sm:6},d.createElement(_.$S,{data:this.state.cities,value:this.state.city_id,func:this.changeCity.bind(this),label:"Город"})),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(_.IA,{value:1==this.state.is_new,func:this.changeData.bind(this,"is_new"),label:"Только новые клиенты"})),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(p.Z,{variant:"contained",onClick:this.updateData.bind(this)},"Обновить данные")),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(_.Qe,{label:"Дата от",value:this.state.date_start,func:this.changeDateRange.bind(this,"date_start")})),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(_.w0,{label:"Время от",value:this.state.time_start,func:this.changeData.bind(this,"time_start")})),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(_.Qe,{label:"Дата до",value:this.state.date_end,func:this.changeDateRange.bind(this,"date_end")})),d.createElement(g.ZP,{item:!0,xs:12,sm:3},d.createElement(_.w0,{label:"Время до",value:this.state.time_end,func:this.changeData.bind(this,"time_end")})),d.createElement(g.ZP,{item:!0,xs:12,sm:6},d.createElement(p.Z,{variant:"contained",onClick:this.getCount.bind(this)},"Подсчитать количество")),d.createElement(g.ZP,{item:!0,xs:12,sm:6},d.createElement(p.Z,{variant:"contained",onClick:this.state.isDrawing?this.startDrawing.bind(this):this.stopDrawing.bind(this)},this.state.isDrawing?"Включить область редактирования":"Выключить область редактирования")),d.createElement(g.ZP,{item:!0,xs:12},d.createElement(g.ZP,{container:!0,spacing:3},d.createElement(g.ZP,{item:!0,xs:6},d.createElement(b.Z,null,"Заказов в зоне: ",this.state.statTrueCount)),d.createElement(g.ZP,{item:!0,xs:6},d.createElement(b.Z,null,"Всего заказов в городе: ",this.state.statAllCount)))),d.createElement(g.ZP,{item:!0,xs:12,sm:12},d.createElement("div",{id:"map",name:"map",style:{width:"100%",height:700,paddingTop:10}}))))}}]),D}(d.Component)},2603:(t,e,a)=>{var n=a(4783)(t.id,{locals:!1});t.hot.dispose(n),t.hot.accept(void 0,n)}}]);
//# sourceMappingURL=542.cd51e6d9a91f9303de12.js.map